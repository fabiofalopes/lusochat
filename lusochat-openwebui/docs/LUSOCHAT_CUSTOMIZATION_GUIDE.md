# Lusochat OpenWebUI Customization System Guide

## Overview
This guide explains the systematic approach for customizing OpenWebUI for Lusófona University (Lusochat) using a non-fork deployment strategy. The system fetches the latest upstream OpenWebUI and applies our specific customizations on top, ensuring we stay current with upstream improvements while maintaining our branding and functionality.

## Architecture & Philosophy

### Non-Fork Approach
- **Fresh Fetching**: Always clone the latest OpenWebUI from upstream
- **Overlay Customizations**: Apply our modifications as targeted patches on top
- **Minimal Impact**: Focus on specific file edits rather than wholesale replacements
- **Validation-First**: Comprehensive validation before applying any changes

### Directory Structure
```
lusochat-openwebui/
├── .lusochat-ldap/               # Our customization assets and configs
│   ├── .env                      # Environment variables for LDAP
│   ├── docker-compose.yaml      # Custom docker deployment config
│   ├── edited-files/             # Custom icons, logos, static assets
│   │   └── app/
│   │       ├── backend/static/   # Backend static files (logos, favicons)
│   │       └── build/            # Frontend build assets
│   └── searxng/                  # SearXNG search engine configuration
├── .lusochat-oidc/              # OIDC configuration (not currently used)
├── open-webui/                  # Cloned upstream (generated by script)
├── deploy_and_apply_lusochat_customizations.sh  # Main deployment script
└── docs/                        # Documentation including this guide
```

## Customization Categories

### 1. Environment Configuration
**Files**: `.lusochat-ldap/.env`, `.lusochat-ldap/docker-compose.yaml`

**Purpose**: Configure LDAP authentication, branding variables, and service setup.

**Key Variables**:
```bash
WEBUI_NAME=Lusochat                    # Main application name
CUSTOM_NAME=lusochat                   # Custom branding identifier
ENABLE_LDAP=true                       # Enable LDAP authentication
LDAP_SERVER_HOST=192.168.201.2         # LDAP server configuration
LDAP_ATTRIBUTE_FOR_USERNAME=sAMAccountName  # Login username format
```

### 2. Visual Branding
**Target Areas**: Icons, logos, favicon, splash screens, app metadata

**Source Files**: `.lusochat-ldap/edited-files/app/`
- `backend/static/favicon.png` - Backend favicon
- `backend/static/logo.png` - Backend logo  
- `backend/static/splash.png` - Splash screen
- `build/static/` - Frontend static assets

**Deployment Targets** (applied by script):
- `static/favicon.png` - Browser tab icon
- `static/static/favicon.png` - Static favicon
- `static/static/apple-touch-icon.png` - Apple touch icon
- `static/static/web-app-manifest-*.png` - PWA icons
- `static/static/splash*.png` - Splash screens

### 3. Application Metadata & Branding
**Target Files**:
- `src/app.html` - Main HTML template, browser tab title, meta tags
- `src/lib/constants.ts` - Frontend application constants
- `backend/open_webui/env.py` - Backend WEBUI_NAME logic
- `static/manifest.json` - PWA manifest
- `static/opensearch.xml` - OpenSearch integration

**Key Customizations**:
- Browser tab title: "Open WebUI" → "Lusochat"
- App name throughout interface
- Meta descriptions and OpenSearch titles
- PWA manifest for mobile installations

### 4. Authentication Interface Customizations
**Target Files**: `src/lib/i18n/locales/*/translation.json`

**Three Key Customizations Implemented**:

#### 4.1 Login Form Username Placeholders
- **Purpose**: Provide clear guidance on expected username formats for Lusófona University
- **Original**: Generic "Enter Your Username" placeholder
- **Customized**: `"Estudante (aXXXXXXXX) / Docente (pXXXX) / Colaborador (fXXXX)"`
- **Implementation**: Updates `"Enter Your Username"` key across all language files
- **Languages Supported**: 57 language variants including Portuguese (PT/BR), English (US/GB), Spanish, French, German, Italian

#### 4.2 Authenticate Button Text
- **Purpose**: Use institutional language that resonates with Portuguese university context
- **Original**: "Authenticate" (generic technical term)
- **Customized**: `"Aceder com dados Institucionais"` (Portuguese: "Access with Institutional Credentials")
- **Implementation**: Updates `"Authenticate"` key across all language files
- **Note**: Primary focus on Portuguese, but applied to all languages for consistency

#### 4.3 Continue with Email Button Discretion
- **Purpose**: Minimize confusion by making email login option less prominent
- **Original**: "Continue with Email" (prominent text button)
- **Customized**: `"⚙️"` (discrete settings gear emoji)
- **Rationale**: Since LDAP is the primary authentication method, email login should be available but not prominent
- **Implementation**: Updates `"Continue with Email"` key across all language files

**Script Functions**:
- `customize_authenticate_button_text()` - Updates Authenticate button across all languages
- `customize_continue_with_email_text()` - Replaces Continue with Email with emoji
- `update_login_placeholders()` - Updates username placeholders with university context

## Deployment Script: `deploy_and_apply_lusochat_customizations.sh`

### Deployment Script: `deploy_and_apply_lusochat_customizations.sh`

### Script Structure
1. **Cleanup & Clone**: Remove old OpenWebUI, clone fresh from upstream
2. **Validation Suite**: Comprehensive compatibility checks before modifications
3. **Customization Application**: Apply targeted edits to specific files
4. **Asset Copying**: Deploy custom icons and static files
5. **Configuration Overlay**: Apply environment and docker configs
6. **Authentication Interface Customization**: Apply the three key UI customizations

### Key Script Functions

#### Validation and Safety Functions
- `echo_success()`, `echo_warning()`, `echo_error()` - Colored output for clarity
- `safe_replace_with_backup()` - Safe string replacement with automatic backup/restore
- `validate_customization_targets()` - Pre-flight checks for file structure compatibility

#### Authentication UI Customization Functions
- `update_login_placeholders()` - Updates username placeholder across all languages
- `customize_authenticate_button_text()` - Changes "Authenticate" to "Aceder com dados Institucionais"
- `customize_continue_with_email_text()` - Replaces "Continue with Email" with "⚙️" emoji

#### Idempotent Design
All customization functions are **idempotent** - they can be run multiple times safely:
- Check if customization already exists before applying
- Skip already-applied changes with appropriate messages
- Support both fresh installations and re-applications

### Validation System
The script includes a 3-phase validation system:

**Phase 1: File Structure Validation**
- Verifies expected OpenWebUI files exist
- Checks for critical customization targets

**Phase 2: Content Pattern Validation**
- Validates expected code patterns exist
- Ensures customization targets haven't changed structure

**Phase 3: Python Syntax Validation**
- Checks Python files for syntax correctness after modifications

### Safe Edit Functions
- `safe_replace()` - Targeted string replacement with validation
- `safe_replace_with_backup()` - Includes automatic backup/restore
- Comprehensive error handling and rollback mechanisms

## Making New Customizations

### Step-by-Step Process

#### 1. Identify Target Component
First, understand what you want to change:
- **UI Text/Labels**: Look in `src/lib/i18n/locales/`
- **App Behavior**: Check `src/lib/constants.ts` or component files
- **Backend Logic**: Examine `backend/open_webui/` files
- **Styling**: Look for CSS files or Tailwind classes in component files
- **Static Assets**: Icons, images in `static/` directories

#### 2. Research OpenWebUI Patterns
Before making changes:
- Check OpenWebUI environment variable documentation
- Look for existing configuration options
- Understand the component's role and dependencies
- Search for similar customizations in the existing script

#### 3. Plan the Change
Determine the implementation approach:
- **Environment Variable**: Can this be changed via configuration?
- **File Edit**: Does this require modifying specific files?
- **Asset Replacement**: Is this a static file that needs replacement?
- **Code Injection**: Does this need new functionality?

#### 4. Update the Deployment Script
Add your customization to `deploy_and_apply_lusochat_customizations.sh`:

**For simple text replacements**:
```bash
# Add to the customization section
safe_replace_with_backup \
    "target_file.extension" \
    "exact_text_to_find" \
    "exact_replacement_text" \
    "Description of what this change does" || true
```

**For new asset files**:
```bash
# Add to the icon/asset copying section
if [ -f "../.lusochat-ldap/edited-files/new-asset.png" ]; then
    cp "../.lusochat-ldap/edited-files/new-asset.png" "target/path/new-asset.png"
    echo_success "Applied new asset: new-asset.png"
fi
```

**For environment variables**:
```bash
# Add to .lusochat-ldap/.env file
NEW_SETTING=value
```

#### 5. Add Validation
Update the validation system to check for your changes:
```bash
# Add to validate_customization_targets()
if [ -f "your_target_file" ]; then
    if grep -q "expected_pattern" "your_target_file"; then
        echo_success "Found expected pattern for your customization"
    else
        log_validation_result "WARNING" "Your customization target changed" "Manual review needed"
    fi
fi
```

#### 6. Test the Changes
1. Run the deployment script: `./deploy_and_apply_lusochat_customizations.sh`
2. Check validation output for any warnings or errors
3. Verify the customization was applied correctly
4. Test the UI/functionality affected by your changes

### Common Customization Patterns

#### Adding New Environment Configuration
```bash
# 1. Add to .lusochat-ldap/.env
NEW_FEATURE_ENABLED=true
NEW_FEATURE_VALUE=custom_value

# 2. Add to deployment script (if needed)
# Most OpenWebUI environment variables work automatically
```

### Specific Authentication UI Changes

#### Adding New Username Placeholder Formats
```bash
# Location: deploy_and_apply_lusochat_customizations.sh
# Function: update_login_placeholders()

# Current implementation updates all 57 languages with:
username_placeholders=(
    "ar:الطالب (aXXXXXXXX) / المدرس (pXXXX) / الموظف (fXXXX)"
    "pt-PT:Estudante (aXXXXXXXX) / Docente (pXXXX) / Colaborador (fXXXX)"
    "en-US:Student (aXXXXXXXX) / Teacher (pXXXX) / Staff (fXXXX)"
    # ... all other languages
)

# To modify the format:
# 1. Update the array above with new format
# 2. Script automatically handles all languages
```

#### Customizing Authenticate Button Text
```bash
# Location: deploy_and_apply_lusochat_customizations.sh
# Function: customize_authenticate_button_text()

# Current implementation:
# Portuguese: "Aceder com dados Institucionais"
# English: "Access with Institutional Data" 
# Other languages: Appropriate translations

# To change the text:
# 1. Modify the text in the function
# 2. Update for each language as needed
```

#### Making UI Elements More/Less Prominent
```bash
# Current: "Continue with Email" → "⚙️"
# Purpose: Make email login discrete while keeping it available

# To change prominence:
# 1. Modify customize_continue_with_email_text() function
# 2. Options:
#    - Use different emoji: "🔧", "⚙️", "📧"
#    - Use short text: "Email", "Alt"
#    - Hide completely: ""
#    - Make prominent again: "Continue with Email"
```

#### Adding Custom Static Assets
```bash
# 1. Place asset in .lusochat-ldap/edited-files/path/
# 2. Add copying logic to script:
if [ -f "../.lusochat-ldap/edited-files/path/new-asset.png" ]; then
    cp "../.lusochat-ldap/edited-files/path/new-asset.png" "static/new-asset.png"
    echo_success "Applied new asset"
fi
```

#### Modifying Component Behavior
```bash
# 1. Identify the source file (usually in src/lib/ or src/routes/)
# 2. Find the specific code section
# 3. Add targeted replacement:
safe_replace_with_backup \
    "src/lib/components/Component.svelte" \
    "old_code_block_with_context" \
    "new_code_block_with_context" \
    "Modified component behavior" || true
```

## Environment Variables Reference

### Core Branding Variables
```bash
WEBUI_NAME=Lusochat                    # Main app name (backend)
CUSTOM_NAME=lusochat                   # Custom identifier
WEBUI_URL=http://localhost:3000        # Base URL for the application
DEFAULT_LOCALE=en                      # Default language
```

### Authentication Variables
```bash
ENABLE_LOGIN_FORM=true                 # Show login form (required for LDAP)
ENABLE_LDAP=true                       # Enable LDAP authentication
LDAP_SERVER_HOST=192.168.201.2         # LDAP server
LDAP_SERVER_PORT=389                   # LDAP port
LDAP_USE_TLS=false                     # Use TLS for LDAP
LDAP_SEARCH_BASE=DC=ulht,DC=gl,DC=pt   # LDAP search base
LDAP_ATTRIBUTE_FOR_USERNAME=sAMAccountName  # Username attribute
LDAP_ATTRIBUTE_FOR_MAIL=mail           # Email attribute
```

### UI Customization Variables
```bash
WEBUI_BANNERS='[{"id":"1","type":"info","title":"Welcome","content":"Welcome to Lusochat","dismissible":true}]'
DEFAULT_PROMPT_SUGGESTIONS='["Hello","How are you?","What can you help with?"]'
RESPONSE_WATERMARK="Generated by Lusochat AI"
```

### Advanced Configuration
```bash
ENABLE_SIGNUP=false                    # Disable new registrations
DEFAULT_USER_ROLE=user                 # Default role for new users
BYPASS_MODEL_ACCESS_CONTROL=false      # Model access control
THREAD_POOL_SIZE=40                    # Performance tuning
```

## Common Build Issues and Solutions

### Memory Issues During Docker Build
**Problem**: `FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory`

**Root Cause**: OpenWebUI frontend build requires significant memory (>4GB) for npm/Node.js compilation with all dependencies including Pyodide packages.

**Solutions**:
1. **Increase Node.js Memory Limit** (Temporary Fix):
   ```dockerfile
   # In Dockerfile, change:
   RUN npm run build
   # To:
   RUN NODE_OPTIONS="--max-old-space-size=4096" npm run build
   ```

2. **Use Dedicated Build Machine**: 
   - Commit changes to git repository
   - Pull and build on machine with >8GB RAM
   - Recommended approach for production

3. **Alternative Build Strategies**:
   ```bash
   # Build with Docker constraints
   docker build --memory=6g --memory-swap=8g -t lusochat-openwebui .
   
   # Or use Docker BuildKit with more resources
   DOCKER_BUILDKIT=1 docker build --build-arg BUILDKIT_INLINE_CACHE=1 .
   ```

**Memory Requirements**:
- **Minimum**: 6GB RAM + 4GB swap
- **Recommended**: 8GB+ RAM for reliable builds
- **Current Machine**: 7.8GB total (insufficient with other processes)

### Script Validation Failures
**Problem**: Validation suite reports errors
**Solution**: 
1. Check if OpenWebUI structure changed in latest version
2. Update validation patterns in the script
3. Adjust customization targets if needed

### Customizations Not Applied
**Problem**: Changes don't appear in the deployed application
**Solution**:
1. Check script output for error messages
2. Verify file paths are correct
3. Ensure Docker rebuild: `docker build -t lusochat-openwebui .`
4. **Idempotent Issue**: If re-running script, functions now check for existing customizations

### Authentication Customizations Not Visible
**Problem**: Button text or placeholders not showing expected changes
**Solution**:
1. **Browser Cache**: Clear browser cache and hard refresh (Ctrl+F5)
2. **Language Settings**: Verify user's language matches customized locale
3. **Docker Rebuild**: Ensure container was rebuilt after script execution
4. **Translation File Check**: Verify changes applied to correct translation files

### LDAP Authentication Issues
**Problem**: Users can't log in via LDAP
**Solution**:
1. Verify LDAP server connectivity
2. Check LDAP_SEARCH_BASE and attribute mappings
3. Enable LDAP debug: `LDAP_DEBUG=true`

### Icon/Asset Issues
**Problem**: Custom icons not showing
**Solution**:
1. Verify asset files exist in `.lusochat-ldap/edited-files/`
2. Check file permissions and formats
3. Clear browser cache
4. Verify PWA manifest references

## Best Practices

### Development Workflow
1. **Always test on latest OpenWebUI**: Run the script regularly to catch upstream changes
2. **Incremental changes**: Make small, focused modifications
3. **Document everything**: Update this guide when adding new customizations
4. **Backup strategy**: The script creates backups, but maintain your own for critical changes

### Security Considerations
1. **Environment Variables**: Never commit sensitive values to git
2. **LDAP Security**: Use proper TLS configuration in production
3. **Access Control**: Regularly review user permissions and roles
4. **Updates**: Keep OpenWebUI updated for security patches

### Performance Optimization
1. **Asset Optimization**: Compress images before adding to edited-files
2. **Environment Tuning**: Adjust THREAD_POOL_SIZE based on usage
3. **Monitoring**: Use WEBUI_BANNERS for maintenance notifications
4. **Caching**: Leverage browser caching for static assets

## Advanced Customization Examples

### Adding a Custom Landing Page Message
```bash
# 1. Add to .lusochat-ldap/.env
WEBUI_BANNERS='[{"id":"welcome","type":"info","title":"Welcome to Lusochat","content":"Your AI assistant for Lusófona University. Need help? Contact IT support.","dismissible":false}]'

# 2. No script changes needed - OpenWebUI handles this automatically
```

### Customizing the Model Selector
```bash
# Add to deployment script:
safe_replace_with_backup \
    "src/lib/components/chat/ModelSelector.svelte" \
    'placeholder="Select a model"' \
    'placeholder="Choose your AI assistant"' \
    "Updated model selector placeholder" || true
```

### Adding Custom CSS/Styling
```bash
# 1. Create custom CSS in .lusochat-ldap/edited-files/app/styles/custom.css
# 2. Add injection to script:
if [ -f "../.lusochat-ldap/edited-files/app/styles/custom.css" ]; then
    cat "../.lusochat-ldap/edited-files/app/styles/custom.css" >> "src/app.css"
    echo_success "Applied custom CSS styling"
fi
```

## Maintenance and Updates

### Regular Maintenance Tasks
1. **Weekly**: Run deployment script to check for upstream changes
2. **Monthly**: Review OpenWebUI changelog for new features/settings
3. **Quarterly**: Update environment variables and configurations
4. **Annually**: Review and update this documentation

### Update Process
1. Pull latest OpenWebUI release
2. Run deployment script with validation
3. Test all customizations
4. Update environment variables if needed
5. Deploy to production

### Monitoring Script Health
The deployment script provides detailed logging:
- ✅ **SUCCESS**: Customization applied correctly
- ⚠️ **WARNING**: Potential issue, manual review recommended
- ❌ **ERROR**: Critical failure, customization skipped
- 🔍 **INFO**: General information and progress

## Getting Help

### Internal Resources
1. This documentation
2. Script validation output
3. OpenWebUI logs: `docker compose logs -f open-webui`

### External Resources
1. [OpenWebUI Documentation](https://docs.openwebui.com/)
2. [OpenWebUI GitHub](https://github.com/open-webui/open-webui)
3. [OpenWebUI Discord](https://discord.gg/5rJgQTnV4s)

### Common Commands
```bash
# Run full deployment
./deploy_and_apply_lusochat_customizations.sh

# Check logs
docker compose logs -f open-webui

# Rebuild without cache
docker build --no-cache -t lusochat-openwebui .

# Reset everything
docker compose down
docker rmi lusochat-openwebui
./deploy_and_apply_lusochat_customizations.sh
```

## Recent Customizations Summary (September 2025)

### Authentication Interface Overhaul
**Date**: September 22, 2025
**Purpose**: Improve user experience for Lusófona University authentication

**Three Key Changes Implemented**:

1. **Username Placeholder Enhancement**
   - **Before**: Generic "Enter Your Username"
   - **After**: "Estudante (aXXXXXXXX) / Docente (pXXXX) / Colaborador (fXXXX)"
   - **Impact**: Users immediately understand expected username format
   - **Languages**: Applied to all 57 supported languages

2. **Authenticate Button Localization**
   - **Before**: "Authenticate" (technical, English-centric)
   - **After**: "Aceder com dados Institucionais" (institutional Portuguese)
   - **Impact**: More natural language for Portuguese university context
   - **Languages**: Primary focus Portuguese, applied universally

3. **Email Login Discretion**
   - **Before**: "Continue with Email" (prominent button)
   - **After**: "⚙️" (discrete emoji)
   - **Impact**: Reduces confusion, emphasizes LDAP as primary method
   - **Rationale**: Email login available but not prominent

**Technical Implementation**:
- All changes applied via `deploy_and_apply_lusochat_customizations.sh`
- Idempotent design allows safe re-execution
- Comprehensive validation prevents upstream compatibility issues
- Applied to 57 language variants for consistency

**Files Modified**:
- `src/lib/i18n/locales/*/translation.json` (57 files)
- Script functions: `update_login_placeholders()`, `customize_authenticate_button_text()`, `customize_continue_with_email_text()`

**Build Challenges Encountered**:
- Memory constraints on deployment machine (7.8GB total RAM)
- Node.js heap limit reached during frontend build
- **Solution**: Commit changes and build on dedicated machine with >8GB RAM

---